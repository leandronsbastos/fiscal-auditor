{% extends "base.html" %}

{% block title %}Agendamentos - Portal ETL{% endblock %}
{% block page_title %}Gerenciamento de Agendamentos{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-clock"></i> Jobs Agendados</h3>
        <button class="btn btn-primary" onclick="showJobModal()">
            <i class="fas fa-plus"></i> Novo Job
        </button>
    </div>
    <div class="card-body">
        <div id="jobsTable">
            <p style="text-align: center; padding: 40px; color: #999;">
                <i class="fas fa-spinner fa-spin"></i> Carregando jobs...
            </p>
        </div>
    </div>
</div>

<!-- Modal de Job -->
<div id="jobModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="jobModalTitle">Novo Job</h3>
            <span class="close" onclick="closeJobModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="jobForm">
                <input type="hidden" id="jobId">
                
                <div class="form-group">
                    <label>Nome do Job *</label>
                    <input type="text" class="form-control" id="jobName" required>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Agendamento *</label>
                    <select class="form-control" id="jobType" onchange="toggleScheduleType()" required>
                        <option value="cron">Cron (expressão)</option>
                        <option value="interval">Intervalo (segundos)</option>
                    </select>
                </div>
                
                <div class="form-group" id="cronGroup">
                    <label>Expressão Cron *</label>
                    <input type="text" class="form-control" id="cronExpression" placeholder="0 */6 * * *">
                    <small style="color: #666;">
                        <strong>Formato:</strong> minuto hora dia mês dia-da-semana<br>
                        <strong>Exemplos:</strong> 0 */6 * * * = a cada 6 horas | 0 0 * * * = diariamente à meia-noite | 0 9 * * 1-5 = dias úteis às 9h
                    </small>
                </div>
                
                <div class="form-group" id="intervalGroup" style="display:none;">
                    <label>Intervalo (segundos) *</label>
                    <input type="number" class="form-control" id="intervalSeconds" min="60" value="3600">
                    <small style="color: #666;">
                        <strong>Parâmetros obrigatórios:</strong> intervalo em segundos (mínimo 60)<br>
                        <strong>Exemplos:</strong> 60 = 1 minuto | 300 = 5 minutos | 3600 = 1 hora | 86400 = 1 dia
                    </small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Instâncias Simultâneas</label>
                        <input type="number" class="form-control" id="maxInstances" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Timeout (segundos)</label>
                        <input type="number" class="form-control" id="timeoutSeconds" value="3600" min="60">
                    </div>
                    <div class="form-group">
                        <label>Tentativas</label>
                        <input type="number" class="form-control" id="retryCount" value="3" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Configuração (JSON)</label>
                    <textarea class="form-control" id="configJson" rows="5" placeholder='{"folder_id": 1, "parallel": true}'>{}</textarea>
                    <small style="color: #666;">
                        <strong>Configurações específicas do job em formato JSON.</strong><br>
                        <strong>Exemplo:</strong> {"folder_id": 1, "parallel": true, "batch_size": 100}
                    </small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isActive" checked> Ativo
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeJobModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="saveJob()">Salvar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let jobs = [];
let currentJobId = null;

async function loadJobs() {
    try {
        const response = await fetch('/api/scheduler/jobs');
        if (response.ok) {
            jobs = await response.json();
            displayJobs(jobs);
        }
    } catch (error) {
        console.error('Erro ao carregar jobs:', error);
        showToast('Erro ao carregar jobs', 'error');
    }
}

function displayJobs(jobs) {
    const container = document.getElementById('jobsTable');
    
    if (!jobs || jobs.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Nenhum job agendado</p>';
        return;
    }
    
    let html = '<table class="data-table"><thead><tr>';
    html += '<th>Nome</th>';
    html += '<th>Tipo</th>';
    html += '<th>Configuração</th>';
    html += '<th>Status</th>';
    html += '<th>Execuções</th>';
    html += '<th>Última Execução</th>';
    html += '<th>Próxima Execução</th>';
    html += '<th>Ações</th>';
    html += '</tr></thead><tbody>';
    
    jobs.forEach(job => {
        const config = job.cron_expression || `${job.interval_seconds}s`;
        const status = job.is_active ? '<span class="badge badge-success">Ativo</span>' : '<span class="badge badge-secondary">Inativo</span>';
        const lastRun = job.last_run ? formatDate(job.last_run) : '-';
        const nextRun = job.next_run ? formatDate(job.next_run) : '-';
        
        html += `<tr>
            <td><strong>${job.name}</strong></td>
            <td>${job.job_type}</td>
            <td><code>${config}</code></td>
            <td>${status}</td>
            <td>
                <small>
                    ${job.run_count || 0} total<br>
                    <span style="color: #28a745;">${job.success_count || 0} OK</span> / 
                    <span style="color: #dc3545;">${job.failure_count || 0} erro</span>
                </small>
            </td>
            <td><small>${lastRun}</small></td>
            <td><small>${nextRun}</small></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="runJobManually(${job.id})" title="Executar">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm ${job.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleJob(${job.id})" title="${job.is_active ? 'Desativar' : 'Ativar'}">
                    <i class="fas fa-${job.is_active ? 'pause' : 'play-circle'}"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="editJob(${job.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteJob(${job.id})" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function showJobModal(jobId = null) {
    currentJobId = jobId;
    const modal = document.getElementById('jobModal');
    
    // Limpar formulário
    document.getElementById('jobForm').reset();
    document.getElementById('jobId').value = '';
    document.getElementById('configJson').value = '{}';
    
    if (jobId) {
        // Edição - carregar dados do job
        const job = jobs.find(j => j.id === jobId);
        if (job) {
            document.getElementById('jobModalTitle').textContent = 'Editar Job';
            document.getElementById('jobId').value = job.id;
            document.getElementById('jobName').value = job.name;
            document.getElementById('jobType').value = job.job_type;
            document.getElementById('cronExpression').value = job.cron_expression || '';
            document.getElementById('intervalSeconds').value = job.interval_seconds || 3600;
            document.getElementById('maxInstances').value = job.max_instances || 1;
            document.getElementById('timeoutSeconds').value = job.timeout_seconds || 3600;
            document.getElementById('retryCount').value = job.retry_count || 3;
            document.getElementById('isActive').checked = job.is_active;
            
            try {
                const config = job.config_json ? JSON.parse(job.config_json) : {};
                document.getElementById('configJson').value = JSON.stringify(config, null, 2);
            } catch(e) {
                document.getElementById('configJson').value = '{}';
            }
            
            toggleScheduleType();
        }
    } else {
        // Novo job
        document.getElementById('jobModalTitle').textContent = 'Novo Job';
        document.getElementById('isActive').checked = true;
        toggleScheduleType();
    }
    
    modal.style.display = 'block';
}

function closeJobModal() {
    document.getElementById('jobModal').style.display = 'none';
}

function toggleScheduleType() {
    const jobType = document.getElementById('jobType').value;
    const cronGroup = document.getElementById('cronGroup');
    const intervalGroup = document.getElementById('intervalGroup');
    
    if (jobType === 'cron') {
        cronGroup.style.display = 'block';
        intervalGroup.style.display = 'none';
        document.getElementById('cronExpression').required = true;
        document.getElementById('intervalSeconds').required = false;
    } else {
        cronGroup.style.display = 'none';
        intervalGroup.style.display = 'block';
        document.getElementById('cronExpression').required = false;
        document.getElementById('intervalSeconds').required = true;
    }
}

async function saveJob() {
    const jobId = document.getElementById('jobId').value;
    const jobType = document.getElementById('jobType').value;
    const jobName = document.getElementById('jobName').value.trim();
    
    // Validar campos obrigatórios
    if (!jobName) {
        showToast('Nome do job é obrigatório', 'error');
        return;
    }
    
    // Validar parâmetros específicos do tipo
    if (jobType === 'interval') {
        const intervalSeconds = parseInt(document.getElementById('intervalSeconds').value);
        if (!intervalSeconds || intervalSeconds < 60) {
            showToast('Intervalo mínimo é 60 segundos (1 minuto)', 'error');
            return;
        }
    } else if (jobType === 'cron') {
        const cronExpression = document.getElementById('cronExpression').value.trim();
        if (!cronExpression) {
            showToast('Expressão cron é obrigatória', 'error');
            return;
        }
    }
    
    // Validar JSON de configuração
    let config = {};
    try {
        config = JSON.parse(document.getElementById('configJson').value || '{}');
    } catch(e) {
        showToast('Configuração JSON inválida', 'error');
        return;
    }
    
    const data = {
        name: document.getElementById('jobName').value,
        job_type: jobType,
        cron_expression: jobType === 'cron' ? document.getElementById('cronExpression').value : null,
        interval_seconds: jobType === 'interval' ? parseInt(document.getElementById('intervalSeconds').value) : null,
        max_instances: parseInt(document.getElementById('maxInstances').value),
        timeout_seconds: parseInt(document.getElementById('timeoutSeconds').value),
        retry_count: parseInt(document.getElementById('retryCount').value),
        is_active: document.getElementById('isActive').checked,
        config: config
    };
    
    console.log('Enviando dados do job:', data);
    
    const url = jobId ? `/api/scheduler/jobs/${jobId}` : '/api/scheduler/jobs';
    const method = jobId ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok || result.error) {
            showToast(result.error || 'Erro ao salvar job', 'error');
            console.error('Erro detalhado:', result);
        } else {
            showToast(jobId ? 'Job atualizado com sucesso' : 'Job criado com sucesso', 'success');
            closeJobModal();
            loadJobs();
        }
    } catch (error) {
        console.error('Erro ao salvar job:', error);
        showToast('Erro de conexão ao salvar job: ' + error.message, 'error');
    }
}

function editJob(id) {
    showJobModal(id);
}

async function deleteJob(id) {
    const job = jobs.find(j => j.id === id);
    if (!job) return;
    
    if (!confirm(`Deseja realmente excluir o job "${job.name}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/scheduler/jobs/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.error) {
            showToast(result.error, 'error');
        } else {
            showToast('Job excluído com sucesso', 'success');
            loadJobs();
        }
    } catch (error) {
        console.error('Erro ao excluir job:', error);
        showToast('Erro ao excluir job', 'error');
    }
}

async function runJobManually(id) {
    const job = jobs.find(j => j.id === id);
    if (!job) return;
    
    if (!confirm(`Executar o job "${job.name}" agora?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/scheduler/jobs/${id}/run`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.error) {
            showToast(result.error, 'error');
        } else {
            showToast('Job iniciado com sucesso', 'success');
            setTimeout(loadJobs, 2000);
        }
    } catch (error) {
        console.error('Erro ao executar job:', error);
        showToast('Erro ao executar job', 'error');
    }
}

async function toggleJob(id) {
    try {
        const response = await fetch(`/api/scheduler/jobs/${id}/toggle`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.error) {
            showToast(result.error, 'error');
        } else {
            showToast(`Job ${result.is_active ? 'ativado' : 'desativado'} com sucesso`, 'success');
            loadJobs();
        }
    } catch (error) {
        console.error('Erro ao alternar job:', error);
        showToast('Erro ao alternar job', 'error');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadJobs();
    setInterval(loadJobs, 30000);
});

// Fechar modal ao clicar fora
window.onclick = function(event) {
    const modal = document.getElementById('jobModal');
    if (event.target == modal) {
        closeJobModal();
    }
}
</script>

<style>
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--card-bg);
    font-weight: 600;
    color: var(--text-primary);
}

.data-table tbody tr:hover {
    background: var(--hover-color);
}

.badge-secondary {
    background: #6c757d;
}

code {
    padding: 4px 8px;
    background: #f5f5f5;
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #ffffff;
    background: #ffffff;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
    background: #ffffff;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #ddd;
    text-align: right;
    background: #f8f9fa;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    background: #ffffff;
    color: #333;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
}

textarea.form-control {
    resize: vertical;
    font-family: 'Courier New', monospace;
}

.btn-warning {
    background: #ffc107;
    color: #000;
}

.btn-warning:hover {
    background: #e0a800;
}
</style>
{% endblock %}
