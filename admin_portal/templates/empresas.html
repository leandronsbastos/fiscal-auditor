<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Empresas e Usuários - Portal Administrativo ETL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            margin-bottom: 1.5rem;
        }
        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        .badge-active {
            background-color: #28a745;
        }
        .badge-inactive {
            background-color: #dc3545;
        }
        .empresa-selected {
            background-color: #e7f3ff !important;
        }
        .usuario-vinculado {
            background-color: #d4edda;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-building"></i> Portal Administrativo ETL
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/scheduler">Jobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/empresas">Empresas</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Lista de Empresas -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Empresas Cadastradas</h5>
                        <button class="btn btn-sm btn-light" onclick="carregarEmpresas()">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="filtroEmpresa" 
                                   placeholder="Filtrar por CNPJ, Razão Social ou Nome Fantasia...">
                        </div>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>CNPJ</th>
                                        <th>Razão Social</th>
                                        <th>Cidade/UF</th>
                                        <th>Usuários</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="listaEmpresas">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Usuários -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Usuários do Sistema</h5>
                        <button class="btn btn-sm btn-light" onclick="carregarUsuarios()">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="filtroUsuario" 
                                   placeholder="Filtrar por nome ou e-mail...">
                        </div>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Nome</th>
                                        <th>E-mail</th>
                                        <th>Empresas</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="listaUsuarios">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Vinculação -->
        <div class="row mt-3" id="painelVinculacao" style="display: none;">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Gerenciar Vinculações</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Empresa Selecionada:</h6>
                                <div id="empresaSelecionadaInfo" class="alert alert-light"></div>
                                
                                <h6 class="mt-3">Usuários Vinculados:</h6>
                                <div class="list-group" id="usuariosVinculados">
                                    <div class="text-center p-3">
                                        <small class="text-muted">Selecione uma empresa</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Vincular Novos Usuários:</h6>
                                <div class="list-group" id="usuariosDisponiveis" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center p-3">
                                        <small class="text-muted">Selecione uma empresa</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let empresas = [];
        let usuarios = [];
        let empresaSelecionada = null;

        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarEmpresas();
            carregarUsuarios();
            
            // Filtros
            document.getElementById('filtroEmpresa').addEventListener('input', filtrarEmpresas);
            document.getElementById('filtroUsuario').addEventListener('input', filtrarUsuarios);
        });

        async function carregarEmpresas() {
            try {
                const response = await fetch('/api/empresas');
                empresas = await response.json();
                renderizarEmpresas(empresas);
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                alert('Erro ao carregar empresas');
            }
        }

        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/usuarios');
                usuarios = await response.json();
                renderizarUsuarios(usuarios);
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                alert('Erro ao carregar usuários');
            }
        }

        function renderizarEmpresas(lista) {
            const tbody = document.getElementById('listaEmpresas');
            
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma empresa encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = lista.map(empresa => `
                <tr onclick="selecionarEmpresa(${empresa.id})" 
                    class="${empresaSelecionada === empresa.id ? 'empresa-selected' : ''}">
                    <td><small>${empresa.cnpj}</small></td>
                    <td>
                        <strong>${empresa.razao_social}</strong>
                        ${empresa.nome_fantasia ? `<br><small class="text-muted">${empresa.nome_fantasia}</small>` : ''}
                    </td>
                    <td><small>${empresa.cidade || '-'}/${empresa.estado || '-'}</small></td>
                    <td><span class="badge bg-secondary">${empresa.total_usuarios}</span></td>
                    <td>
                        <span class="badge ${empresa.ativo ? 'badge-active' : 'badge-inactive'}">
                            ${empresa.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderizarUsuarios(lista) {
            const tbody = document.getElementById('listaUsuarios');
            
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum usuário encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = lista.map(usuario => `
                <tr>
                    <td><strong>${usuario.nome}</strong></td>
                    <td><small>${usuario.email}</small></td>
                    <td><span class="badge bg-secondary">${usuario.total_empresas}</span></td>
                    <td>
                        <span class="badge ${usuario.ativo ? 'badge-active' : 'badge-inactive'}">
                            ${usuario.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        async function selecionarEmpresa(empresaId) {
            empresaSelecionada = empresaId;
            const empresa = empresas.find(e => e.id === empresaId);
            
            // Atualizar visual
            renderizarEmpresas(empresas);
            
            // Mostrar painel de vinculação
            document.getElementById('painelVinculacao').style.display = 'block';
            
            // Exibir info da empresa
            document.getElementById('empresaSelecionadaInfo').innerHTML = `
                <strong>${empresa.razao_social}</strong><br>
                <small>CNPJ: ${empresa.cnpj}</small>
            `;
            
            // Carregar usuários vinculados
            await carregarUsuariosVinculados(empresaId);
        }

        async function carregarUsuariosVinculados(empresaId) {
            try {
                const response = await fetch(`/api/empresas/${empresaId}/usuarios`);
                const vinculados = await response.json();
                
                // Renderizar usuários vinculados
                const divVinculados = document.getElementById('usuariosVinculados');
                if (vinculados.length === 0) {
                    divVinculados.innerHTML = '<div class="text-center p-3"><small class="text-muted">Nenhum usuário vinculado</small></div>';
                } else {
                    divVinculados.innerHTML = vinculados.map(u => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${u.nome}</strong><br>
                                <small class="text-muted">${u.email}</small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="desvincularUsuario(${empresaId}, ${u.id})">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    `).join('');
                }
                
                // Renderizar usuários disponíveis
                const vinculadosIds = new Set(vinculados.map(u => u.id));
                const disponiveis = usuarios.filter(u => !vinculadosIds.has(u.id) && u.ativo);
                
                const divDisponiveis = document.getElementById('usuariosDisponiveis');
                if (disponiveis.length === 0) {
                    divDisponiveis.innerHTML = '<div class="text-center p-3"><small class="text-muted">Todos os usuários já estão vinculados</small></div>';
                } else {
                    divDisponiveis.innerHTML = disponiveis.map(u => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${u.nome}</strong><br>
                                <small class="text-muted">${u.email}</small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="vincularUsuario(${empresaId}, ${u.id})">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Erro ao carregar usuários vinculados:', error);
            }
        }

        async function vincularUsuario(empresaId, usuarioId) {
            try {
                const response = await fetch(`/api/empresas/${empresaId}/usuarios/${usuarioId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await carregarEmpresas();
                    await carregarUsuarios();
                    await carregarUsuariosVinculados(empresaId);
                } else {
                    alert('Erro ao vincular usuário');
                }
            } catch (error) {
                console.error('Erro ao vincular usuário:', error);
                alert('Erro ao vincular usuário');
            }
        }

        async function desvincularUsuario(empresaId, usuarioId) {
            if (!confirm('Deseja realmente remover este vínculo?')) return;
            
            try {
                const response = await fetch(`/api/empresas/${empresaId}/usuarios/${usuarioId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await carregarEmpresas();
                    await carregarUsuarios();
                    await carregarUsuariosVinculados(empresaId);
                } else {
                    alert('Erro ao desvincular usuário');
                }
            } catch (error) {
                console.error('Erro ao desvincular usuário:', error);
                alert('Erro ao desvincular usuário');
            }
        }

        function filtrarEmpresas() {
            const filtro = document.getElementById('filtroEmpresa').value.toLowerCase();
            const filtradas = empresas.filter(e => 
                e.cnpj.toLowerCase().includes(filtro) ||
                e.razao_social.toLowerCase().includes(filtro) ||
                (e.nome_fantasia && e.nome_fantasia.toLowerCase().includes(filtro))
            );
            renderizarEmpresas(filtradas);
        }

        function filtrarUsuarios() {
            const filtro = document.getElementById('filtroUsuario').value.toLowerCase();
            const filtrados = usuarios.filter(u => 
                u.nome.toLowerCase().includes(filtro) ||
                u.email.toLowerCase().includes(filtro)
            );
            renderizarUsuarios(filtrados);
        }
    </script>
</body>
</html>
