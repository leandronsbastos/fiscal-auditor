<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fiscal Auditor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Fiscal Auditor</h1>
            <p>Dashboard de Resultados</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <a href="/" class="btn btn-secondary">‚Üê Novo Processamento</a>
                <a href="/produtos" class="btn btn-primary" style="background: #28a745;">üì¶ Vis√£o por Produto</a>
                <a href="/analise-tributaria" class="btn btn-primary" style="background: #667eea;">üìä An√°lise Tribut√°ria</a>
            </div>
        </header>

        <!-- Resumo Geral -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Documentos Processados</h3>
                <div class="summary-value">{{ documentos|length }}</div>
                <small>Total de documentos</small>
            </div>
            <div class="summary-card">
                <h3>Entradas</h3>
                <div class="summary-value">{{ relatorios.entradas.quantidade_documentos }}</div>
                <small>R$ {{ "%.2f"|format(relatorios.entradas.valor_total|float) }}</small>
            </div>
            <div class="summary-card">
                <h3>Sa√≠das</h3>
                <div class="summary-value">{{ relatorios.saidas.quantidade_documentos }}</div>
                <small>R$ {{ "%.2f"|format(relatorios.saidas.valor_total|float) }}</small>
            </div>
            <div class="summary-card">
                <h3>Per√≠odo</h3>
                <div class="summary-value">{{ mapa.periodo }}</div>
                <small>Compet√™ncia</small>
            </div>
        </div>

        <!-- Mapa de Apura√ß√£o -->
        <div class="card">
            <h2>üìà Mapa de Apura√ß√£o</h2>
            <div class="table-responsive">
                <table class="apuracao-table">
                    <thead>
                        <tr>
                            <th>Tributo</th>
                            <th>D√©bitos (Sa√≠das)</th>
                            <th>Cr√©ditos (Entradas)</th>
                            <th>Saldo</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for apuracao in mapa.apuracoes %}
                        <tr>
                            <td><strong>{{ apuracao.tipo.value }}</strong></td>
                            <td class="valor-debito">R$ {{ "%.2f"|format(apuracao.debitos) }}</td>
                            <td class="valor-credito">R$ {{ "%.2f"|format(apuracao.creditos) }}</td>
                            <td class="valor-saldo">
                                <strong>R$ {{ "%.2f"|format(apuracao.saldo|abs) }}</strong>
                            </td>
                            <td>
                                {% if apuracao.saldo > 0 %}
                                <span class="badge badge-danger">A Recolher</span>
                                {% elif apuracao.saldo < 0 %}
                                <span class="badge badge-success">Credor</span>
                                {% else %}
                                <span class="badge badge-neutral">Zerado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Documentos Processados -->
        <div class="card">
            <h2>üìÑ Documentos Processados</h2>
            <div class="table-responsive">
                <table class="documentos-table">
                    <thead>
                        <tr>
                            <th>N√∫mero</th>
                            <th>Tipo</th>
                            <th>Movimento</th>
                            <th>Emitente</th>
                            <th>Destinat√°rio</th>
                            <th>Valor Total</th>
                            <th>Itens</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documentos %}
                        <tr>
                            <td>{{ doc.numero }}</td>
                            <td><span class="badge badge-info">{{ doc.tipo.value }}</span></td>
                            <td>
                                {% if doc.tipo_movimento.value == 'Entrada' %}
                                <span class="badge badge-success">‚¨áÔ∏è {{ doc.tipo_movimento.value }}</span>
                                {% else %}
                                <span class="badge badge-warning">‚¨ÜÔ∏è {{ doc.tipo_movimento.value }}</span>
                                {% endif %}
                            </td>
                            <td>{{ doc.cnpj_emitente }}</td>
                            <td>{{ doc.cnpj_destinatario }}</td>
                            <td>R$ {{ "%.2f"|format(doc.valor_total) }}</td>
                            <td>{{ doc.items|length }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Valida√ß√µes -->
        <div class="card">
            <h2>‚úÖ Resultado das Valida√ß√µes</h2>
            
            <!-- Resumo Geral das Valida√ß√µes -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                {% set total_docs = validacoes|length %}
                {% set docs_validos = validacoes|selectattr('valido', 'equalto', true)|list|length %}
                {% set docs_problemas = total_docs - docs_validos %}
                {% set total_aproveitaveis = validacoes|selectattr('creditos_aproveitaveis')|list|length if validacoes else 0 %}
                {% set total_indevidos = validacoes|selectattr('creditos_indevidos')|list|length if validacoes else 0 %}
                {% set total_glosaveis = validacoes|selectattr('creditos_glosaveis')|list|length if validacoes else 0 %}
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; font-weight: bold; margin-bottom: 5px;">{{ total_docs }}</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Documentos Analisados</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; font-weight: bold; margin-bottom: 5px;">{{ docs_validos }}</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">‚úÖ Documentos V√°lidos</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); padding: 20px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; font-weight: bold; margin-bottom: 5px;">{{ docs_problemas }}</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">‚ö†Ô∏è Com Problemas</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-around; font-size: 0.85em;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold;">{{ total_aproveitaveis }}</div>
                            <div style="opacity: 0.9;">Aproveit√°veis</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold;">{{ total_indevidos }}</div>
                            <div style="opacity: 0.9;">Indevidos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold;">{{ total_glosaveis }}</div>
                            <div style="opacity: 0.9;">Glos√°veis</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista Detalhada de Valida√ß√µes -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                {% for validacao in validacoes %}
                <div style="background: white; border-radius: 8px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.08); transition: box-shadow 0.3s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.08)'">
                    <!-- Header do Documento -->
                    <div style="background: {% if validacao.valido %}linear-gradient(135deg, #11998e 0%, #38ef7d 100%){% else %}linear-gradient(135deg, #ee0979 0%, #ff6a00 100%){% endif %}; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span style="font-size: 1.8em; margin-right: 12px;">{% if validacao.valido %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                            <div style="color: white;">
                                <strong style="font-size: 1.05em; display: block; margin-bottom: 3px;">{% if validacao.valido %}Documento V√°lido{% else %}Documento com Problemas{% endif %}</strong>
                                <div style="font-size: 0.85em; opacity: 0.95; font-family: monospace;">{{ validacao.chave_acesso }}</div>
                            </div>
                        </div>
                        {% if validacao.mensagens %}
                        <span style="background: rgba(255,255,255,0.3); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;">
                            {{ validacao.mensagens|length }} mensagem{% if validacao.mensagens|length > 1 %}ns{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Estat√≠sticas dos Cr√©ditos -->
                    <div style="padding: 15px 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div style="background: #d4edda; padding: 12px; border-radius: 6px; border-left: 4px solid #28a745; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #155724;">{{ validacao.creditos_aproveitaveis|length }}</div>
                                <div style="font-size: 0.85em; color: #155724; margin-top: 3px;">‚úì Aproveit√°veis</div>
                            </div>
                            <div style="background: #f8d7da; padding: 12px; border-radius: 6px; border-left: 4px solid #dc3545; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #721c24;">{{ validacao.creditos_indevidos|length }}</div>
                                <div style="font-size: 0.85em; color: #721c24; margin-top: 3px;">‚úó Indevidos</div>
                            </div>
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #856404;">{{ validacao.creditos_glosaveis|length }}</div>
                                <div style="font-size: 0.85em; color: #856404; margin-top: 3px;">! Glos√°veis</div>
                            </div>
                        </div>
                        
                        <!-- Mensagens de Valida√ß√£o -->
                        {% if validacao.mensagens %}
                        <div style="background: #f1f3f5; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #6c757d;">
                            <strong style="color: #495057; font-size: 0.9em; display: block; margin-bottom: 8px;">üìã Detalhes da Valida√ß√£o:</strong>
                            <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
                                {% for msg in validacao.mensagens %}
                                <li style="color: #495057; font-size: 0.9em; margin: 6px 0; padding-left: 15px; position: relative;">
                                    <span style="position: absolute; left: 0; color: #6c757d;">‚Ä¢</span>
                                    {{ msg }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Relat√≥rios para Download -->
        <div class="card">
            <h2>üì• Exportar Relat√≥rios</h2>
            <div class="relatorios-grid">
                <button onclick="exportarExcel()" class="relatorio-link" style="border: none; cursor: pointer;">
                    <span class="icon">üìä</span>
                    <span>Exportar para Excel</span>
                </button>
                <button onclick="exportarPDF()" class="relatorio-link" style="border: none; cursor: pointer;">
                    <span class="icon">üìÑ</span>
                    <span>Exportar para PDF</span>
                </button>
                <a href="/api/relatorios/entradas" class="relatorio-link" download>
                    <span class="icon">üìÑ</span>
                    <span>Demonstrativo de Entradas (JSON)</span>
                </a>
                <a href="/api/relatorios/saidas" class="relatorio-link" download>
                    <span class="icon">üìÑ</span>
                    <span>Demonstrativo de Sa√≠das (JSON)</span>
                </a>
                <a href="/api/relatorios/mapa" class="relatorio-link" download>
                    <span class="icon">üìä</span>
                    <span>Mapa de Apura√ß√£o (JSON)</span>
                </a>
                <a href="/api/relatorios/validacao" class="relatorio-link" download>
                    <span class="icon">‚úÖ</span>
                    <span>Relat√≥rio de Valida√ß√£o (JSON)</span>
                </a>
                <a href="/api/relatorios/completo" class="relatorio-link" download>
                    <span class="icon">üìã</span>
                    <span>Relat√≥rio Completo (JSON)</span>
                </a>
            </div>
        </div>
    </div>

    <footer>
        <p>Fiscal Auditor ¬© 2026 - Sistema de Auditoria e Apura√ß√£o Tribut√°ria</p>
    </footer>

    <script>
        async function exportarExcel() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/export/excel', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `relatorio_fiscal_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Erro ao exportar para Excel');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao exportar para Excel');
            }
        }

        async function exportarPDF() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/export/pdf', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `relatorio_fiscal_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Erro ao exportar para PDF');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao exportar para PDF');
            }
        }
    </script>
</body>
</html>
