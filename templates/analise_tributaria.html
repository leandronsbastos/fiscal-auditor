<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Tribut√°ria - Fiscal Auditor</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .analise-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .produto-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .produto-header h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .cfop-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .cfop-tag {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
        }
        
        .cfop-valido {
            border: 2px solid #28a745;
        }
        
        .cfop-invalido {
            border: 2px solid #dc3545;
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        
        .cfop-invalido::after {
            content: " ‚ö†Ô∏è";
        }
        
        .tributos-comparacao {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .tributo-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .tributo-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .tributo-dados {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .tributo-entrada {
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
        }
        
        .tributo-saida {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
        }
        
        .tributo-label {
            font-size: 0.8em;
            font-weight: 600;
            color: #666;
            margin-bottom: 3px;
        }
        
        .tributo-valor {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        .tributo-aliquota {
            font-size: 0.9em;
            color: #666;
            margin-top: 3px;
        }
        
        .diferenca-card {
            background: #d1ecf1;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #bee5eb;
        }
        
        .diferenca-positiva {
            color: #28a745;
            font-weight: bold;
        }
        
        .diferenca-negativa {
            color: #dc3545;
            font-weight: bold;
        }
        
        .sem-movimento {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Fiscal Auditor</h1>
            <p>An√°lise Tribut√°ria por Produto</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <a href="/dashboard" class="btn btn-secondary">‚Üê Dashboard</a>
                <a href="/produtos" class="btn btn-secondary">üì¶ Vis√£o por Produto</a>
                <a href="/" class="btn btn-secondary">Novo Processamento</a>
            </div>
        </header>

        <!-- Resumo -->
        <div class="card">
            <h2>üìà Resumo da An√°lise</h2>
            <div class="summary-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="summary-card">
                    <h3>Total de Produtos</h3>
                    <div class="summary-value">{{ analise.total_produtos }}</div>
                    <small>NCMs analisados</small>
                </div>
                <div class="summary-card">
                    <h3>Data da An√°lise</h3>
                    <div class="summary-value" style="font-size: 1.2em;">
                        {{ analise.data_geracao[:10] }}
                    </div>
                    <small>{{ analise.data_geracao[11:19] }}</small>
                </div>
            </div>
        </div>

        <!-- An√°lise por Produto -->
        {% for produto in analise.produtos %}
        <div class="analise-card">
            <div class="produto-header">
                <h3>{{ produto.descricao }}</h3>
                <p style="color: #666; margin: 5px 0;">
                    <strong>NCM:</strong> {{ produto.ncm }}
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <strong style="color: #28a745;">üì• CFOPs de Entrada:</strong>
                        <div class="cfop-tags">
                            {% for cfop in produto.cfop_entradas %}
                            {% set primeiro_digito = cfop[0] if cfop else '' %}
                            {% set cfop_valido = primeiro_digito in ['1', '2', '3'] %}
                            <span class="cfop-tag {% if cfop_valido %}cfop-valido{% else %}cfop-invalido{% endif %}" 
                                  style="background: #d4edda; color: #155724;"
                                  title="{% if cfop_valido %}CFOP correto para entrada{% else %}ATEN√á√ÉO: CFOP inv√°lido para entrada! CFOPs de entrada devem come√ßar com 1, 2 ou 3{% endif %}">
                                {{ cfop }}
                            </span>
                            {% endfor %}
                            {% if not produto.cfop_entradas %}
                            <span style="color: #999; font-style: italic;">Sem entradas</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <strong style="color: #dc3545;">üì§ CFOPs de Sa√≠da:</strong>
                        <div class="cfop-tags">
                            {% for cfop in produto.cfop_saidas %}
                            {% set primeiro_digito = cfop[0] if cfop else '' %}
                            {% set cfop_valido = primeiro_digito in ['5', '6', '7'] %}
                            <span class="cfop-tag {% if cfop_valido %}cfop-valido{% else %}cfop-invalido{% endif %}" 
                                  style="background: #fff3cd; color: #856404;"
                                  title="{% if cfop_valido %}CFOP correto para sa√≠da{% else %}ATEN√á√ÉO: CFOP inv√°lido para sa√≠da! CFOPs de sa√≠da devem come√ßar com 5, 6 ou 7{% endif %}">
                                {{ cfop }}
                            </span>
                            {% endfor %}
                            {% if not produto.cfop_saidas %}
                            <span style="color: #999; font-style: italic;">Sem sa√≠das</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compara√ß√£o Tribut√°ria -->
            <div class="tributos-comparacao">
                {% for tributo in ['ICMS', 'IPI', 'PIS', 'COFINS', 'IBS', 'CBS'] %}
                {% set analise_trib = produto.analise_tributaria[tributo] %}
                {% set credito = analise_trib.credito|float %}
                {% set debito = analise_trib.debito|float %}
                
                {% if credito > 0 or debito > 0 %}
                <div class="tributo-card">
                    <h4>{{ tributo }}</h4>
                    
                    <div class="tributo-dados">
                        <div class="tributo-entrada">
                            <div class="tributo-label">üì• Cr√©dito (Entrada)</div>
                            <div class="tributo-valor">R$ {{ "%.2f"|format(credito) }}</div>
                            <div class="tributo-aliquota">
                                Al√≠q. m√©dia: {{ "%.2f"|format(analise_trib.percentual_entrada|float) }}%
                            </div>
                        </div>
                        
                        <div class="tributo-saida">
                            <div class="tributo-label">üì§ D√©bito (Sa√≠da)</div>
                            <div class="tributo-valor">R$ {{ "%.2f"|format(debito) }}</div>
                            <div class="tributo-aliquota">
                                Al√≠q. m√©dia: {{ "%.2f"|format(analise_trib.percentual_saida|float) }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="diferenca-card">
                        <div class="tributo-label">üí∞ Diferen√ßa (Cr√©dito - D√©bito)</div>
                        {% set diferenca = analise_trib.diferenca|float %}
                        <div style="font-size: 1.2em;">
                            <span class="{% if diferenca > 0 %}diferenca-positiva{% elif diferenca < 0 %}diferenca-negativa{% endif %}">
                                R$ {{ "%.2f"|format(diferenca|abs) }}
                            </span>
                            {% if diferenca > 0 %}
                            <small style="color: #28a745;">(Cr√©dito a aproveitar)</small>
                            {% elif diferenca < 0 %}
                            <small style="color: #dc3545;">(A recolher)</small>
                            {% else %}
                            <small style="color: #666;">(Neutro)</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Resumo de Valores -->
            <div style="margin-top: 20px; padding: 15px; background: #f1f3f5; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #28a745;">üì• Total Entradas:</strong>
                        <div style="font-size: 1.2em; color: #333; margin-top: 5px;">
                            R$ {{ "%.2f"|format(produto.entradas.valor_total|float) }}
                        </div>
                        <small style="color: #666;">
                            Qtd: {{ "%.2f"|format(produto.entradas.quantidade|float) }} | 
                            Docs: {{ produto.entradas.documentos }}
                        </small>
                    </div>
                    <div>
                        <strong style="color: #dc3545;">üì§ Total Sa√≠das:</strong>
                        <div style="font-size: 1.2em; color: #333; margin-top: 5px;">
                            R$ {{ "%.2f"|format(produto.saidas.valor_total|float) }}
                        </div>
                        <small style="color: #666;">
                            Qtd: {{ "%.2f"|format(produto.saidas.quantidade|float) }} | 
                            Docs: {{ produto.saidas.documentos }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Exportar Relat√≥rios -->
        <div class="card">
            <h2>üì• Exportar Relat√≥rios</h2>
            <div class="relatorios-grid">
                <button onclick="exportarExcel()" class="relatorio-link" style="border: none; cursor: pointer;">
                    <span class="icon">üìä</span>
                    <span>Exportar para Excel</span>
                </button>
                <button onclick="exportarPDF()" class="relatorio-link" style="border: none; cursor: pointer;">
                    <span class="icon">üìÑ</span>
                    <span>Exportar para PDF</span>
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>Fiscal Auditor ¬© 2026 - An√°lise Tribut√°ria Detalhada</p>
    </footer>

    <script>
        async function exportarExcel() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/export/excel', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `relatorio_fiscal_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Erro ao exportar para Excel');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao exportar para Excel');
            }
        }

        async function exportarPDF() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/export/pdf', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `relatorio_fiscal_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Erro ao exportar para PDF');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao exportar para PDF');
            }
        }
    </script>
</body>
</html>
