<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence Fiscal - An√°lise Tribut√°ria</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --border: #e1e4e8;
            --text-primary: #24292e;
            --text-secondary: #586069;
            --text-muted: #6a737d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* Header */
        .header-section {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }
        
        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .content-wrapper {
            display: block;
        }
        
        .content-section {
            padding: 24px 32px;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .kpi-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px 24px;
            transition: all 0.2s;
        }
        
        .kpi-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #d1d5da;
        }
        
        .kpi-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 12px;
        }
        
        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }
        
        .kpi-description {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Section Headers */
        .section-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .section-description {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Chart Section */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 24px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .chart-canvas {
            max-height: 280px;
        }
        
        /* Table Section */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .table-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .table-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-primary);
        }
        
        th {
            padding: 12px 24px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 14px 24px;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        tbody tr:hover {
            background-color: #fafbfc;
        }
        
        .numeric {
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: var(--text-secondary);
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Error State */
        .error-message {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-left: 4px solid var(--danger);
            color: #742a2a;
            padding: 16px 20px;
            border-radius: 6px;
            margin: 24px 0;
            font-size: 14px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 14px;
        }
        
        /* Filters Section */
        .filters-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <h1 class="page-title">Business Intelligence Fiscal - Fase 1</h1>
            <p class="page-subtitle">An√°lise de Campos Cr√≠ticos e Indicadores Tribut√°rios</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="content-section">
        <div class="loading">
            <div class="spinner"></div>
            <p class="loading-text">Carregando an√°lise fiscal...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="content" style="display: none;">
        <div class="content-section"
        
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total de Documentos</div>
                <div class="kpi-value" id="kpi-total">‚Äî</div>
                <div class="kpi-description">NF-es processadas</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Pagamento Eletr√¥nico</div>
                <div class="kpi-value" id="kpi-pagamento">‚Äî</div>
                <div class="kpi-description">Documentos com pagamento eletr√¥nico</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Intermediador</div>
                <div class="kpi-value" id="kpi-intermediador">‚Äî</div>
                <div class="kpi-description">Opera√ß√µes com intermediador</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Benef√≠cios Fiscais</div>
                <div class="kpi-value" id="kpi-beneficios">‚Äî</div>
                <div class="kpi-description">C√≥digos identificados</div>
            </div>
        </div>

        <!-- Indicadores de Presen√ßa e Opera√ß√£o -->
        <div class="section-header">
            <h2 class="section-title">Indicadores de Opera√ß√£o</h2>
            <p class="section-description">Distribui√ß√£o de documentos por tipo de presen√ßa e perfil de consumidor</p>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h3 class="chart-title">Indicador de Presen√ßa do Comprador</h3>
                <canvas id="chartPresenca" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Indicador de Consumidor Final</h3>
                <canvas id="chartFinal" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Pagamento e Intermedia√ß√£o -->
        <div class="section-header">
            <h2 class="section-title">Pagamento e Intermedia√ß√£o</h2>
            <p class="section-description">An√°lise de formas de pagamento e opera√ß√µes com intermediadores</p>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h3 class="chart-title">Formas de Pagamento Eletr√¥nico</h3>
                <canvas id="chartPagamento" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Opera√ß√µes com Intermediador</h3>
                <canvas id="chartIntermediador" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Top Naturezas de Opera√ß√£o -->
        <div class="section-header">
            <h2 class="section-title">Naturezas de Opera√ß√£o</h2>
            <p class="section-description">Principais tipos de opera√ß√µes identificadas nos documentos fiscais</p>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Top 10 Naturezas de Opera√ß√£o</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Natureza da Opera√ß√£o</th>
                        <th class="numeric">Quantidade</th>
                        <th class="numeric">Participa√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="table-naturezas">
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">Nenhum dado dispon√≠vel</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Top Benef√≠cios Fiscais -->
        <div class="section-header">
            <h2 class="section-title">Benef√≠cios Fiscais</h2>
            <p class="section-description">C√≥digos de benef√≠cios fiscais mais utilizados</p>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Top 10 Benef√≠cios Fiscais</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>C√≥digo do Benef√≠cio</th>
                        <th class="numeric">Quantidade de Itens</th>
                        <th class="numeric">Participa√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="table-beneficios">
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üéØ</div>
                            <div class="empty-state-text">Nenhum dado dispon√≠vel</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Intermediadores -->
        <div class="section-header">
            <h2 class="section-title">Intermediadores Identificados</h2>
            <p class="section-description">CNPJs de intermediadores em opera√ß√µes de marketplace e e-commerce</p>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Lista de Intermediadores</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>CNPJ</th>
                        <th class="numeric">Total de Opera√ß√µes</th>
                        <th class="numeric">Participa√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="table-intermediadores">
                    <tr>
                        <td colspan="3" class="empty-state">
                            <div class="empty-state-icon">üè¢</div>
                            <div class="empty-state-text">Nenhum intermediador identificado</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <script>
        let charts = {};
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('empresa_id');

        async function carregarEstatisticas() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const empresaId = urlParams.get('empresa_id');
                
                if (!empresaId) {
                    throw new Error('ID da empresa n√£o informado');
                }

                const response = await fetch(`/api/estatisticas/fase1?empresa_id=${empresaId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar dados: ${response.status}`);
                }

                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Atualizar KPIs
                document.getElementById('kpi-total').textContent = data.total_nfes.toLocaleString('pt-BR');
                document.getElementById('kpi-pagamento').textContent = (data.pagamento_eletronico?.total_com_pagamento || 0).toLocaleString('pt-BR');
                document.getElementById('kpi-intermediador').textContent = (data.indicadores?.intermediador?.['1'] || 0).toLocaleString('pt-BR');
                document.getElementById('kpi-beneficios').textContent = (data.beneficios_fiscais?.length || 0).toLocaleString('pt-BR');
                
                // Renderizar gr√°ficos
                renderizarGraficos(data);
                
                // Renderizar tabelas
                renderizarTabelaNaturezas(data.naturezas_operacao, data.total_nfes);
                renderizarTabelaBeneficios(data.beneficios_fiscais);
                renderizarTabelaIntermediadores(data.intermediadores);
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <strong>Erro ao carregar estat√≠sticas:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function renderizarGraficos(data) {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 16,
                            font: {
                                size: 12,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
                            },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    }
                }
            };

            // Gr√°fico de Presen√ßa
            if (data.indicadores?.presenca) {
                const labels = {
                    '1': 'Presencial',
                    '2': 'Internet',
                    '3': 'Teleatendimento',
                    '4': 'Entrega Domic√≠lio',
                    '9': 'Outros'
                };
                
                charts.presenca = new Chart(document.getElementById('chartPresenca'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.indicadores.presenca).map(k => labels[k] || k),
                        datasets: [{
                            data: Object.values(data.indicadores.presenca),
                            backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#95a5a6'],
                            borderWidth: 0
                        }]
                    },
                    options: chartOptions
                });
            }

            // Gr√°fico Consumidor Final
            if (data.indicadores?.final) {
                charts.final = new Chart(document.getElementById('chartFinal'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Opera√ß√£o Normal', 'Consumidor Final'],
                        datasets: [{
                            data: [data.indicadores.final['0'] || 0, data.indicadores.final['1'] || 0],
                            backgroundColor: ['#95a5a6', '#3498db'],
                            borderWidth: 0
                        }]
                    },
                    options: chartOptions
                });
            }

            // Gr√°fico Pagamento
            if (data.pagamento_eletronico?.tipos) {
                const tiposPag = {
                    '01': 'Dinheiro',
                    '02': 'Cheque',
                    '03': 'Cart√£o Cr√©dito',
                    '04': 'Cart√£o D√©bito',
                    '05': 'Cr√©dito Loja',
                    '10': 'Vale Alimenta√ß√£o',
                    '11': 'Vale Refei√ß√£o',
                    '12': 'Vale Presente',
                    '13': 'Vale Combust√≠vel',
                    '15': 'Boleto Banc√°rio',
                    '16': 'Dep√≥sito Banc√°rio',
                    '17': 'PIX',
                    '18': 'Transfer√™ncia',
                    '19': 'Fidelidade',
                    '90': 'Sem Pagamento',
                    '99': 'Outros'
                };
                
                charts.pagamento = new Chart(document.getElementById('chartPagamento'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.pagamento_eletronico.tipos).map(k => tiposPag[k] || k),
                        datasets: [{
                            label: 'Quantidade',
                            data: Object.values(data.pagamento_eletronico.tipos),
                            backgroundColor: '#3498db',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        ...chartOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: '#e1e4e8'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico Intermediador
            if (data.indicadores?.intermediador) {
                charts.intermediador = new Chart(document.getElementById('chartIntermediador'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Sem Intermediador', 'Com Intermediador'],
                        datasets: [{
                            data: [data.indicadores.intermediador['0'] || 0, data.indicadores.intermediador['1'] || 0],
                            backgroundColor: ['#95a5a6', '#27ae60'],
                            borderWidth: 0
                        }]
                    },
                    options: chartOptions
                });
            }
        }

        function renderizarTabelaNaturezas(naturezas, total) {
            const tbody = document.getElementById('table-naturezas');
            if (!naturezas || naturezas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6a737d; padding: 32px;">Nenhum dado dispon√≠vel</td></tr>';
                return;
            }

            tbody.innerHTML = naturezas.map((item, index) => {
                const participacao = ((item.total / total) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${index + 1}¬∫</td>
                        <td>${item.natureza}</td>
                        <td class="numeric">${item.total.toLocaleString('pt-BR')}</td>
                        <td class="numeric">${participacao}%</td>
                    </tr>
                `;
            }).join('');
        }

        function renderizarTabelaBeneficios(beneficios) {
            const tbody = document.getElementById('table-beneficios');
            if (!beneficios || beneficios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6a737d; padding: 32px;">Nenhum dado dispon√≠vel</td></tr>';
                return;
            }

            const totalItens = beneficios.reduce((acc, b) => acc + b.total_itens, 0);
            tbody.innerHTML = beneficios.map((item, index) => {
                const participacao = ((item.total_itens / totalItens) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${index + 1}¬∫</td>
                        <td>${item.codigo}</td>
                        <td class="numeric">${item.total_itens.toLocaleString('pt-BR')}</td>
                        <td class="numeric">${participacao}%</td>
                    </tr>
                `;
            }).join('');
        }

        function renderizarTabelaIntermediadores(intermediadores) {
            const tbody = document.getElementById('table-intermediadores');
            if (!intermediadores || intermediadores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6a737d; padding: 32px;">Nenhum intermediador identificado</td></tr>';
                return;
            }

            const totalOps = intermediadores.reduce((acc, i) => acc + i.total_operacoes, 0);
            tbody.innerHTML = intermediadores.map(item => {
                const participacao = ((item.total_operacoes / totalOps) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${item.cnpj}</td>
                        <td class="numeric">${item.total_operacoes.toLocaleString('pt-BR')}</td>
                        <td class="numeric">${participacao}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Carregar ao iniciar
        carregarEstatisticas();
    </script>
</body>
</html>
